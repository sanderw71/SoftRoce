#include <stdio.h>
#include <stdint.h>
#include <stdlib.h>
#include <string.h>
#include "crc32.h"
#include <linux/kernel.h>

unsigned char connect_request[] = {
  0x00, 0x15, 0x5d, 0x24, 0x01, 0x04, 0x00, 0x15,
  0x5d, 0x01, 0x02, 0x0d, 0x08, 0x00, 0x45, 0x00,
  0x01, 0x34, 0xb6, 0xaf, 0x40, 0x00, 0x40, 0x11,
  0xfe, 0xed, 0xc0, 0xa8, 0x01, 0x66, 0xc0, 0xa8,
  0x01, 0x65, 0xd8, 0x72, 0x12, 0xb7, 0x01, 0x20,
  0x00, 0x00, 0x64, 0x00, 0xff, 0xff, 0x00, 0x00,
  0x00, 0x01, 0x80, 0x00, 0x00, 0x0c, 0x80, 0x01,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x01, 0x07,
  0x02, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x02, 0xd5, 0x67, 0x2a, 0x51, 0x00, 0x10,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x51, 0x2a,
  0x67, 0xd5, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x01, 0x06, 0x1c, 0x06, 0x02, 0x15,
  0x5d, 0xff, 0xfe, 0x01, 0x02, 0x0d, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x11, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00,
  0x00, 0xa0, 0xd6, 0x36, 0x75, 0xa7, 0xff, 0xff,
  0x37, 0xf0, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0xff, 0xff, 0xc0, 0xa8, 0x01, 0x66, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0xff, 0xff, 0xc0, 0xa8, 0x01, 0x65, 0x14, 0xa6,
  0x40, 0x00, 0x00, 0x40, 0x00, 0x98, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x40, 0x8d, 0xe2, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0xc0, 0xa8, 0x01, 0x66, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0xc0, 0xa8, 0x01, 0x65, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xbf, 0x0a,
  0x9d, 0xe4
};

char rc_send_only[] = {
    0x00, 0x15, 0x5d, 0x24, 0x01, 0x04, 0x00, 0x15,
    0x5d, 0x01, 0x02, 0x0d, 0x08, 0x00, 0x45, 0x00, 
    0x00, 0x3c, 0xb6, 0xb4, 0x40, 0x00, 0x40, 0x11, 
    0xff, 0xe0, 0xc0, 0xa8, 0x01, 0x66, 0xc0, 0xa8, 
    0x01, 0x65, 0xdf, 0x94, 0x12, 0xb7, 0x00, 0x28, 
    0x00, 0x00, 0x04, 0x00, 0xff, 0xff, 0x00, 0x00, 
    0x00, 0x11, 0x80, 0xa5, 0x98, 0x0a, 0x00, 0x00, 
    0x56, 0x40, 0x02, 0x37, 0x0a, 0xb0, 0x00, 0x00, 
    0x10, 0x63, 0x00, 0x00, 0x00, 0x40, 0xa1, 0x85, 
    0x56, 0x85
};

cm_t cm;
p_cm_t p_cm = &cm;

uint32_t be32_to_le32(uint32_t value) 
{
    return (((value >> 24)  &0x000000ff) | // move byte 3 to byte 0
           ((value  << 8 )  &0x00ff0000) | // move byte 1 to byte 2
           ((value  >> 8 )  &0x0000ff00) | // move byte 2 to byte 1
           ((value  << 24)  &0xff000000)); // byte 0 to byte 3
}

uint32_t calc_icrc32(char *data, int len) 
{
  int brh_offset = 14;
  int checksum_length = 4;
  int l;
  char pseudo_lrh[] = {
    0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF};

  cm_ini(p_cm);

  // Create an array that concatenates input array with pseaudo LRH header of 8x 0xFF

  char icrc_array[len + sizeof(pseudo_lrh) - brh_offset - checksum_length]; 
  memcpy(icrc_array, pseudo_lrh, sizeof(pseudo_lrh));
  memcpy(&icrc_array[sizeof(pseudo_lrh)], &data[brh_offset], len -checksum_length);

  icrc_array[9]  = 0xFF; // Differentiated Service Field (DSCP, ECN)
  icrc_array[16] = 0xFF; // Time to live
  icrc_array[18] = 0xFF; // IP Header checksum
  icrc_array[19] = 0xFF; // IP Header checksum
  icrc_array[34] = 0xFF; // UDP Header checksum
  icrc_array[35] = 0xFF; // UDP Header checksum
  icrc_array[40] = 0xFF; // BTH reserved field, resv8a

  // printf("Array for ICRC calculation: \n");
  // for (l = 0; l < sizeof(icrc_array); l++)
  // {
  //   if ((l % 8 == 0) & (l != 0))
  //   {
  //     printf("\n");
  //   }
  //   printf("0x%-10x ", (unsigned char)icrc_array[l]);
  // }
  // printf("\n");

  int16_t max = sizeof(icrc_array);

  for (uint16_t j = 0; j < max; j += 1)
  {
    cm_nxt(p_cm, icrc_array[j]); 
  }

  uint32_t icrc_be32 = (cm_crc(p_cm) & 0xffffffff);
  uint32_t icrc = be32_to_le32(icrc_be32);

  return icrc;
}


int Crc_Checking(void)
{
  uint32_t icrc;

  icrc = calc_icrc32(connect_request, sizeof(connect_request));
  printf("icrc = %x\n", icrc);

  icrc = calc_icrc32(rc_send_only, sizeof(rc_send_only));
  printf("icrc = %x\n", icrc);
}

void initCrc(void)
{
  memset(p_cm, 0, sizeof(cm));

  p_cm->cm_width = 32;
  p_cm->cm_poly = 0x04C11DB7;
  p_cm->cm_init = 0xFFFFFFFF;
  p_cm->cm_refin = 1;
  p_cm->cm_refot = 1;
  p_cm->cm_xorot = 0xFFFFFFFF;
  cm_ini(p_cm);

  Crc_Checking();
}

